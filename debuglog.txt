prod@raspberrypi:~ $ sudo bash /media/prod/USBTOOL/diagphp.sh
==========================================================================
ğŸ” DIAGNOSTIC DOWNLOADBUTTON WIDGET - DROPDOWNS VIDES
==========================================================================


ğŸ” 1. VÃ‰RIFICATION DES FICHIERS CSV RÃ‰ELS
----------------------------------------
  â€¢ RÃ©pertoire principal Archives... âœ… PASS - RÃ©pertoire existe
    â„¹ï¸  Chemin: /home/prod/Documents/traÃ§abilitÃ©/Archives
    â„¹ï¸  Permissions: 755 www-data:www-data
  â€¢ RÃ©pertoire 2025... âœ… PASS - RÃ©pertoire 2025 existe
    â„¹ï¸  Chemin: /home/prod/Documents/traÃ§abilitÃ©/Archives/2025
    â„¹ï¸  Permissions: 755 www-data:www-data
  â€¢ Fichiers CSV dans 2025... âœ… PASS - 6 fichiers CSV trouvÃ©s
    ğŸ“ Liste des fichiers :
      â€¢ S01_2025_machine1.csv (634 bytes, 644 www-data:www-data)
      â€¢ S03_2025_machine1.csv (634 bytes, 644 www-data:www-data)
      â€¢ S01_2025_machine2.csv (634 bytes, 644 www-data:www-data)
      â€¢ S02_2025_machine1.csv (634 bytes, 644 www-data:www-data)
      â€¢ S02_2025_machine2.csv (634 bytes, 644 www-data:www-data)
      â€¢ S03_2025_machine2.csv (634 bytes, 644 www-data:www-data)
  â€¢ Pattern des noms de fichiers...       âœ… S01_2025_machine1.csv (pattern valide)
      âœ… S03_2025_machine1.csv (pattern valide)
      âœ… S01_2025_machine2.csv (pattern valide)
      âœ… S02_2025_machine1.csv (pattern valide)
      âœ… S02_2025_machine2.csv (pattern valide)
      âœ… S03_2025_machine2.csv (pattern valide)
âš ï¸  WARN - Certains fichiers ont un pattern invalide

ğŸ” 2. TEST DES PERMISSIONS D'ACCÃˆS
----------------------------------------
  â€¢ Permissions lecture pour www-data... âŒ FAIL - www-data ne peut pas lire le rÃ©pertoire Archives
âŒ FAIL - www-data ne peut pas lire le rÃ©pertoire 2025
  â€¢ AccÃ¨s aux fichiers CSV pour www-data...       âŒ S01_2025_machine1.csv - Non lisible par www-data
      âŒ S03_2025_machine1.csv - Non lisible par www-data
      âŒ S01_2025_machine2.csv - Non lisible par www-data
      âŒ S02_2025_machine1.csv - Non lisible par www-data
      âŒ S02_2025_machine2.csv - Non lisible par www-data
      âŒ S03_2025_machine2.csv - Non lisible par www-data

ğŸ” 3. TEST DE L'API ARCHIVES-LIST.PHP
----------------------------------------
  â€¢ AccÃ¨s HTTP Ã  l'API... âœ… PASS - API accessible (HTTP 200)
  â€¢ Validation JSON de la rÃ©ponse... âœ… PASS - JSON valide retournÃ©
    ğŸ“Š Analyse de la structure JSON :
    â„¹ï¸  AnnÃ©es trouvÃ©es: 0 (format array au lieu d'objet)
    â„¹ï¸  DonnÃ©es 2025: non trouvÃ©
    ğŸ“„ Ã‰chantillon de la rÃ©ponse (premiers 500 caractÃ¨res) :
[]


ğŸ” 4. COMPARAISON STRUCTURE DONNÃ‰ES
----------------------------------------
  ğŸ“‹ Structure ATTENDUE par le widget :
    {
      "2025": {
        "week_1": {
          "start_date": "2025-01-01",
          "end_date": "2025-01-07", 
          "file_count": 2,
          "total_size": 1234
        },
        "week_2": { ... }
      }
    }

  ğŸ“‹ Structure RETOURNÃ‰E par l'API :
[]
    ... (tronquÃ©)

ğŸ” 5. TEST DIRECT PHP (sans HTTP)
----------------------------------------
  â€¢ ExÃ©cution directe du script PHP... âœ… PASS - Script PHP s'exÃ©cute sans erreur
âœ… PASS - JSON valide en sortie directe
    â„¹ï¸  AnnÃ©es trouvÃ©es (direct): 0

ğŸ” 6. RECOMMANDATIONS DE CORRECTION
----------------------------------------
  ğŸ”§ Actions recommandÃ©es :

  2. ğŸ”„ PROBLÃˆME DE STRUCTURE DE DONNÃ‰ES :
     â€¢ L'API retourne des donnÃ©es mais dans un format incompatible
     â€¢ Modifier l'API pour retourner la structure attendue
     â€¢ OU modifier le widget pour comprendre la structure actuelle

  ğŸ› ï¸  SCRIPTS UTILES :
     â€¢ Corriger permissions : sudo chmod -R 755 '/home/prod/Documents/traÃ§abilitÃ©/Archives' && sudo chown -R www-data:www-data '/home/prod/Documents/traÃ§abilitÃ©/Archives'
     â€¢ Tester API : curl -s http://localhost/archives-list.php | python3 -m json.tool
     â€¢ Logs PHP : sudo tail -f /var/log/nginx/error.log

==========================================================================
ğŸ DIAGNOSTIC TERMINÃ‰
==========================================================================
